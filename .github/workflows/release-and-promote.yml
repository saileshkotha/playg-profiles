name: Release & Promote

on:
  push:
    branches:
      - main


permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REGISTRY: ${{ vars.ECR_REGISTRY }}
  ECR_REPOSITORY: 'profiles/profiles-api'

jobs:
  release-and-promote:
    runs-on: ubuntu-latest
    steps:
      # ── Checkout ───────────────────────────────────────────────
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      # ── Node / pnpm ───────────────────────────────────────────
      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      # ── Build TypeScript ───────────────────────────────────────
      - run: pnpm -r build

      # ── AWS credentials ───────────────────────────────────────
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Log in to ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      # ── Build & push Docker image with sha tag ────────────────
      - name: Build and push Docker image
        id: docker
        run: |
          IMAGE="${ECR_REGISTRY}/${ECR_REPOSITORY}"
          SHA_TAG="sha-${GITHUB_SHA}"

          docker build \
            -f services/profiles-api/Dockerfile \
            --build-arg GIT_SHA="${GITHUB_SHA}" \
            -t "${IMAGE}:${SHA_TAG}" \
            .

          docker push "${IMAGE}:${SHA_TAG}"

          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "${IMAGE}:${SHA_TAG}" | cut -d@ -f2)
          echo "sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "digest=${DIGEST}"   >> "$GITHUB_OUTPUT"
          echo "image=${IMAGE}"     >> "$GITHUB_OUTPUT"

#      # ── Tag integration ────────────────────────────────────────
#      - name: Create integration ECR tag
#        id: int-tag
#        run: |
#          SHORT_SHA="${GITHUB_SHA:0:7}"
#          TIMESTAMP=$(date -u +"%Y%m%d%H%M%S")
#          INT_TAG="int-${SHORT_SHA}-${TIMESTAMP}"
#
#          bash services/profiles-api/scripts/tag-ecr.sh \
#            "${ECR_REGISTRY}" "${ECR_REPOSITORY}" \
#            "${{ steps.docker.outputs.sha_tag }}" "${INT_TAG}" \
#            "${AWS_REGION}"
#
#          # Optional floating tag
#          bash services/profiles-api/scripts/tag-ecr.sh \
#            "${ECR_REGISTRY}" "${ECR_REPOSITORY}" \
#            "${{ steps.docker.outputs.sha_tag }}" "integration" \
#            "${AWS_REGION}" || true
#
#          echo "int_tag=${INT_TAG}" >> "$GITHUB_OUTPUT"
#
#      # ── Wait for integration healthy ───────────────────────────
#      - name: Wait for integration environment
#        run: |
#          bash services/profiles-api/scripts/wait-argocd-app.sh \
#            "${{ vars.ARGOCD_BASE_URL_INT }}" \
#            "${{ secrets.ARGOCD_AUTH_TOKEN }}" \
#            "${{ vars.ARGOCD_APP_NAME_INT }}" \
#            300
#
#      # ── Semantic Release ───────────────────────────────────────
#      - name: Semantic Release
#        id: release
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#        run: |
#          OUTPUT=$(npx semantic-release 2>&1) || true
#          echo "${OUTPUT}"
#
#          VERSION=$(echo "${OUTPUT}" | grep -oP 'Published release \K[0-9]+\.[0-9]+\.[0-9]+' || true)
#
#          if [ -z "${VERSION}" ]; then
#            echo "No new release created."
#            echo "released=false" >> "$GITHUB_OUTPUT"
#          else
#            echo "Released version: ${VERSION}"
#            echo "released=true"        >> "$GITHUB_OUTPUT"
#            echo "version=${VERSION}"   >> "$GITHUB_OUTPUT"
#          fi
#
#      # ── Promote to staging (semver tag) ────────────────────────
#      - name: Tag ECR with semver for staging
#        if: steps.release.outputs.released == 'true'
#        run: |
#          bash services/profiles-api/scripts/tag-ecr.sh \
#            "${ECR_REGISTRY}" "${ECR_REPOSITORY}" \
#            "${{ steps.docker.outputs.sha_tag }}" \
#            "${{ steps.release.outputs.version }}" \
#            "${AWS_REGION}"
#
#      # ── Wait for staging healthy ───────────────────────────────
#      - name: Wait for staging environment
#        if: steps.release.outputs.released == 'true'
#        run: |
#          bash services/profiles-api/scripts/wait-argocd-app.sh \
#            "${{ vars.ARGOCD_BASE_URL_STG }}" \
#            "${{ secrets.ARGOCD_AUTH_TOKEN }}" \
#            "${{ vars.ARGOCD_APP_NAME_STG }}" \
#            300
